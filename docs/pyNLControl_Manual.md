# pyNLControl

pyNLControl is the package for nonlinear control and estimation. It is python based package. Almost all of the module will be applicable to linear system as well. Some might be applicable only to nonlinear or linear only.

## Requirements
* python >= 3.6 (might work on older version of python3, not tested)
* casadi>=3.5.5 and jinja2>=3.0.2 `pip install casadi jinja2 `


## Installations

```
pip install pyNLControl
```

## Supported control and estimator
* Estimators: Kalman filter, Extended Kalman Filter and Unscented Kalman Filter. Partical filter, moving horizon estimator, etc will be added soon.
* Control: Nonlinear Model Predictive Control will be added soon
* Misc: Nonlinear observability analysis, Noise covariance identification will be added soon

Module pynlcontrol.BasicUtils
=============================

Functions
---------

    
`Gen_Code(func, filename, dir='/', mex=False, printhelp=False, optim=False)`
:   Function to generate c code (casadi generated as well as interface) for casadi function.
    
    Args:
        func (casadi.Function): CasADi function for which code needs to be generated
        filename (str): Name of the generated code
        dir (str, optional): Directory where codes need to be generated. Defaults to current directory.
        mex (bool, optional): Option if mex is required. Defaults to False.
        printhelp (bool, optional): Option if information about input/output and its size are to be printed . If mex is False, sfunction help is also printed. Defaults to False.

    
`Gen_Test(headers, varsIn, sizeIn, varsOut, sizeOut, callFuncName, filename, dir='/')`
:   Generates C code with main function. This code along with code generated by `Gen_Code` function can be compiled to executable to check computation time or debug.
    It can also be used as example to compile on other target.
    
    Args:
        headers (list[str]): List of header files name along with extension .h). These files will be added in main file as #include "header".
        varsIn (list[str]): List of name of input variables.
        sizeIn (list[int]): List of size of input variables.
        varsOut (list(str)): List of name of output variables.
        sizeOut (list(int)): List of size of output variables.
        callFuncName (str): Name of the C function that needs to be called.
        filename (str): Name of the generated C file (along with extension .c).
        dir ([str], optional): Directory where code needs to be generated. Defaults to current directory.

    
`Integrate(odefun, method, Ts, x0, u0, *args)`
:   Function to integrate continuous-time ODE. It discretize the provided ODE function and gives value of state variables at next discrete time. 
    
    Args:
        odefun (function): Python function with states as first and control input as second argument. Remaining argument could be anything required by state equations
        method (str): Method to integrate ODE. Supported methods are: 'FEuler', 'rk2', 'rk3', 'ssprk3', 'rk4', 'dormandprince'.
        Ts (float): Step time to solve ODE
        x0 (float or casadi.SX or numpy.1darray): Current states of the system
        u0 (float or casadi.SX or numpy.1darray): Current control input to the system
    
    Returns:
        float or casadi.SX or numpy.1darray: Next states of the system

    
`nlp2GGN(z, J, g, lbg, ubg, p)`
:   Converts provided nonlinear programming into quadratic form using generalized Gauss-Newton method.
    
    Args:
        z (casadi.SX): Vector of unknown variables of optimization problem
        J (casadi.SX): Object function of the optimization problem
        g (casadi.SX): Vector of constraints function
        lbg (casadi.SX): Vector of lower limits on constraint function
        ubg (casadi.SX): Vector of upper limits on constraint function
        p (casadi.SX): Vector of input to the optimization problem
    
    Returns:
        dict: Dictionary of optimization problem.
              keywords
              x: Vector of decision variables 
              f: New quadratic cost function
              g: New constraint function
              lbg: Lower limits on constraint function
              ubg: Upper limits on constraint function

Module pynlcontrol.Estimation
=============================

Functions
---------

    
`EKF(nX, nU, nY, F, H, Qw, Rv, Ts, Integrator='rk4')`
:   Function to implement Extended Kalman filter.
    
    Args:
        nX (int): Number of state variables
        nU (int): Number of control inputs
        ny (int): Number of measurement outputs
        F (function): Function that returns right-hand side of state differential equation
        H (function): Function that retuns measurement variable from state variable
        Qw (numpy.2darray or casadi.SX array): Process noise covariance matrix
        Rv (numpy.2darray or casadi.SX array): Measurement noise covariance matrix
        Ts (float): Sample time of the Kalman filter.
        Integrator (str, optional): Integration method. Defaults to 'rk4'. For list of supported integrator, please see documentation of function `Integrate`.
    
    Returns:
        tuple: Tuple of Input, Output, Input name and Output name. Inputs are u, y, xp, Pp and output are xhat and Phat. Input and output are casadi symbolics (`casadi.SX`).
            u: Current input to the system
            y: Current measurement of the system
            xp: State estimate from previous discrete time
            Pp: Covariance estimate from previous discrete time (reshaped to column matrix)
            xhat: State estimate at current discrete time
            Phat: Covariance estimate at current discrete time (reshaped to column matrix)
    
            These inputs are and outputs can be mapped using `casadi.Function` which can further be code generated.

    
`KF(nX, nU, nY, Ad, Bd, Cd, Qw, Rv)`
:   Function to implement Kalman filter. 
    
    Args:
        nX (int): Number of state variables
        nU (int): Number of control inputs
        nY (int): Number of measurement outputs
        Ad (numpy.2darray or casadi.SX array): Discrete-time state matrix of the system
        Bd (numpy.2darray or casadi.SX array): Discrete-time input matrix of the system
        Cd (numpy.2darray or casadi.SX array): Discrete-time measurement matrix of the system
        Qw (numpy.2darray or casadi.SX array): Process noise covariance matrix
        Rv (numpy.2darray or casadi.SX array): Measurement noise covariance matrix
    
    Returns:
        tuple: Tuple of Input, Output, Input name and Output name. Inputs are u, y, xp, Pp and output are xhat and Phat. Input and output are casadi symbolics (`casadi.SX`).
            u: Current input to the system
            y: Current measurement of the system
            xp: State estimate from previous discrete time
            Pp: Covariance estimate from previous discrete time (reshaped to column matrix)
            xhat: State estimate at current discrete time
            Phat: Covariance estimate at current discrete time (reshaped to column matrix)
    
            These inputs are and outputs can be mapped using `casadi.Function` which can further be code generated.

    
`simpleMHE(nX, nU, nY, nP, N, Fc, Hc, Wp, Wm, Ts, pLower=[], pUpper=[], arrival=False, GGN=False, Integrator='rk4', Options=None)`
:   Function to generate simple MHE code using `qrqp` solver. For use with other advanced solver, see `MPC` class.
    
    Args:
        nX (int): Number of state variables.
        nU (int): number of control input.
        nY (int): Number of measurement variables.
        nP (int): Number of parameter to be estimated. nP=0 while performing state estimation only.
        N (int): Horizon length.
        Fc (function): Function that returns right hand side of state equation.
        Hc (function): Function that returns right hand side of measurement equation.
        Wp (float or casadi.SX array or numpy.2darray): Weight for process noise term. It is $Q_w^{-1/2}$ where $Q_w$ is process noise covariance.
        Wm (float or casadi.SX array or numpy.2darray): Weight for measurement noise term. It is $R_v^{-1/2}$ where $R_v$ is measurement noise covariance.
        Ts (float): Sample time for MHE
        pLower (list, optional): List of lower limits of unknown parameters. Defaults to [].
        pUpper (list, optional): List of upper limits of unknown parameters. Defaults to [].
        arrival (bool, optional): Whether to include arrival cost. Defaults to False.
        GGN (bool, optional): Whether to use GGN. Use this option only when optimization problem is nonlinear. Defaults to False.
        Integrator (str, optional): Integration method. See `BasicUtils.Integrate()` function. Defaults to 'rk4'.
        Options (dict, optional): Option for `qrqp` solver. Defaults to None.
    
    Returns:
        tuple: tuple: Tuple of Input, Output, Input name and Output name. Input and output are list of casadi symbolics (`casadi.SX`).
            Input should be control input and measurement data of past horizon length
            Output are all value of decision variable, estimations of parameter, estimates of states and cost function.

Module pynlcontrol.QPInterface
==============================

Classes
-------

`qpOASES(H, g, p=None, A=None, lbA=None, ubA=None, lbx=None, ubx=None)`
:   Class to create interface to qpOASES solver.
    
    Args:
        H (casadi.SX): Hessian matrix of cost function
        g (casadi.SX): Linear coefficient vector of cost function
        p (list, optional): List of input parameters to optimization problem. Defaults to None.
        A (casadi.SX, optional): Constraint matrix. Defaults to None.
        lbA (casadi.SX, optional): Lower bound on constraint matrix. Defaults to None.
        ubA (casadi.SX, optional): Upper bound on constraint matrix. Defaults to None.
        lbx (casadi.SX, optional): Lower bound on decision variables. Defaults to None.
        ubx (casadi.SX, optional): Upper bound on decision variables. Defaults to None.

    ### Methods

    `exportCode(self, filename, dir='/', mex=False, printsfun=False, Options=None, TestCode=False)`
    :   Method of class qpOASES to export the code that solves quadratic programming.
        
        Args:
            filename (str): Filename for exported code.
            dir (str, optional): Directory where code is to be exported. Defaults to '/'.
            mex (bool, optional): Whether mex interface is required. Defaults to False.
            printsfun (bool, optional): Whether MATLAB s-function interface is to be implemented. Defaults to False.
            Options (dict, optional): Options for qpOASES solver. Defaults to None.
            TestCode (bool, optional): Whether main function is required. Useful while testing and debugging. Defaults to False.

    `exportEvalCode(self, funcname, dir='/', options=None)`
    :   Method of class qpOASES to generate C code to evaluate H, h, A, lbA, ubA, lbx, ubx.
        
        Args:
            funcname (str): Function to be named that evaluates H, h, A, lbA, ubA, lbx and ubx.
            dir (str, optional): Directory where codes are to be exported. Defaults to '/'.
            options (dict, optional): Options for code generation. Same option as casadi.Function.generate() function. Defaults to None.